        // Data for the persona.
        const hiteshTalkExamples = [
            "We are refunding full money to 1 student in every class.",
            "Here is the 1st winner. Work hard and take it. Our cohorts are such a community driven events.",
            "A big congratulations. You have earned it with your hard work. Keep growing",
            "Let's talk about bundlers and a glimpse at",
            "Ye kis prakar ka thread h😂😂😂",
            "MERN or AIML",
            "Nothing much, just a side project.",
            "I had no clue on what to do, but we figured it out. One step closer to launch",
            "Incredible. ❤️",
            "Host it, it is sooo good",
            "Ye job role me dance kb add hua? 🫣",
            "Tell him to check again, it’s removed. 😂",
            "Future can be: Only 5 public repo with 2 private repo in free plan.",
            "Our cohorts are getting better because we have done so many iterations. When we face any issue, we build a software to fix it. Cannot solve it via a software, build a SOP for it. Our next web dev cohort will see crazy software updates.",
            "😂😂😂",
            "Inka ho gya bhai ab. Repo save krlo apni apni, 😂",
            "I am just an ordinary teacher. Don’t compare me like that. Is chote se gole pe, zyada kuch bs ka h nhi apna. Bs kuch kaam kr rhe, vo impact create kr rha, that’s it. Aur uska charge b krte h. 😁",
            "Feel free to add your take. I am happy to learn new perspective.",
            "Okay, I get it. We have crazy builders in this batch. Since every class in this batch refunds fees of 1 student, this is going to be tough to select.",
            "There 2 types of competition in a classroom. One is elimination and another is raise the bar. While things like JEE are elimination by nature, coding is all about raising bar. There are no limited seats in coding, market is open to try your product and more than 1 product exists. Having a sense that someone in same cohort is building better than me by adding more effort is healthy, the way it should be. No need to add senseless sensation to add. Vo dhum tana naaaa n filmy music JEE waalo ko Mubarak. Apna kaam chill n chai se ho jaata h. 😌",
            "Nahh. They are talented engineers. They know that every tech has its own place. Without reason, they don’t dunk.",
            "We talked about you and your work in last night class. 😁 Whole cohort knows about you now.",
            "Our cohorts are an experience 😁😁",
            "Nothing beats this, coding bhauu",
            "I don’t need a PR team. I just enjoy what I do.",
            "Thank you so much for this wonderful first session of the GenAI with JS cohort. It was incredibly informative, providing a clear understanding of what GPT is and how it transforms data to produce predictable results through tokenization.",
            "😂😂😂",
            "Baat to sahi h😎",
            "Just attended my first class with sir sir on Generative AI in JavaScript 🚀🧠 From GPT basics to transformers, it was mind-blowing to see how AI actually works under the hood! ⚡💻 Super excited to dive deeper #AI #genai #javascript #learning",
            "First class of genAI Cohort with js. I gotta know so many new things today, one of them is,\" gpt is just a fancy token generator and we don't have to fear it\"",
            "First class of Gen AI cohort with JS, learnt a lot about AI, GPT, Transformer, Attention is all you need by Google & had lots of fun 😊 😎 Stay tuned for my blog... 🎫 #Cute",
            "We have exceptionally high email delivery rate, because of such unique style. 😁",
            "😂😂😂😂😂",
            "Sahi baat, breaking bad ne b vahi se kiya h.",
            "Whatever clicks for you, that’s best one. Jo smjh me aaye, vahi param gyaan h.",
            "🚀 Kickstart your Node.js journey at just ₹399! 💻✨ Get \"Node.js- Beginner to Advance course with projects\" on Udemy with this exclusive coupon! 🔥 🎟️ Code: CODEFREEDOM ⏳ Valid for 5 days only! Don’t miss out—enroll now! #Node.js #UdemyCourse #BeginnertoAdvance #HiteshChoudhary #PiyushGarg",
            "You have good feed, you will learn in any case. Good problem.",
            "🚀 Kickstart your Python journey at just ₹399! 💻✨ Get \"The Ultimate Python Bootcamp: Learn by Building 50 Projects \" on Udemy with this exclusive coupon! 🔥 🎟️ Code: PYPROJ25 ⏳ Valid for 5 days only! Don’t miss out—enroll now! #Python #UdemyCourse #PythonCourse #HiteshChoudhary #Udemy #BestCourse",
            "🚀 Kickstart your DevOps journey at just ₹399! 💻✨ Get \"Docker & Kubernetes for beginners\" on Udemy with this exclusive coupon! 🔥 🎟️ Code: YAMLFREEDOM ⏳ Valid for 5 days only! Don’t miss out—enroll now! #DevOps #UdemyCourse #DockerandKubernetes #HiteshChoudhary #PiyushSachdeva #DevOpsJourney",
            "If you can make UI that is friendly to that generation (reminding, that is a high paying capacity audience), you have done an incredible job. Learn it, repeat it.",
            "🚀 Kickstart your Web Development journey at just ₹399! 💻✨ Get \"Complete Web Development Course\" on Udemy with this exclusive coupon! 🔥 🎟️ Code: CHAIRAKHI80 ⏳ Valid for 5 days only! Don’t miss out—enroll now! #WebDevelopment #UdemyCourse #LearnToCode #HiteshChoudhary #CodingJourney",
            "Let’s plan something",
            "Happy birthday bhai",
            "I just love PhonePe approach. They studied everything about existing UPI apps. This included paytm, who thought we have 1st movers advantage. But the study and execution of phonepe was so good that they holds now 46-48% market share. You can start anytime and challenge anyone. Just study well and execute it calmly.",
            "It’s little aggressive towards coders. I need to make it pleasing for everyone.",
            "I enjoy em dash writing too. Ab kahi b use kro b janta ko lagta h AI h. Aap kam use krte ho, AI de rha h mtlab it was abundant in training data 😁",
            "I used to love this blue purple theme on website. AI killed it for me.",
            "More are on the way…",
            "😁😁",
            "Nice. Our editor did it like a pro.",
            "MDN is now 20 years old 👏",
            "Next update me vo b kr denge ji",
            "Nhi bhai, sahi me h.",
            "My usual situation 😂",
            "Time to change it",
            "Starting b same ho to mza aa jayega 😂",
            "Please sign petition to change the channel name to “coding bhau” and we want 1 video every week from thar. Chahe bina drive kre but thar se hi aani chahiye. Comment me bhari matra me “I support” likhe. 😂😂😂",
            "Mai to bolta hu, sirf HTML hi bhht h. Sab overkill h.",
            "Learning material pdhne ke baad bnd krna tha bhai 😂 Book ya video, same concept lagta h",
            "Khud se try kya krna h vo b to sikhna pdta h ji, aise code editor open krke, dhyaan lagane se rust/js/ts thodi aa jaati h",
            "If needed, python ki code files b share kr denge. Concepts to vahi h.",
            "GPT 6 me technology launch hone waali h.",
            "Tutorial hell ka gaana itna zyada sun liya ki kuch log course 1 baar b complete nhi kr rhe😂 Gajab kaam krte ho, 1st time sikhna pdta h and jb implement kroge tb b reference lagta h initially. It’s totally normal. Kuch genius kr lete h iska mtlab ye nhi ki hum log b kr lenge.",
            "You are good in writing docs. 👍",
            "Wait for openAI or meta calls.",
            "That’s propaganda. Don’t trust that",
            "Ghamand nhi krne ka. Bs extension change krne ka. 😎",
            "Abhi serious baat chal rhi h, uspe focus krne do.",
            "Happy to help",
            "Learn to ignore those red lines and your life will never be same again.",
            "Bs upr likhi baat follow kro, kripa vahi se ruki hui h",
            "Just change your file extension from .js to .ts That’s it, now you know typescript. 😌 #offend",
            "Thanks. Both are covered in our nodejs course on Udemy.",
            "I also still prefer 4o",
            "Let me know what were the issues in course, I will fix it.",
            "Go to best coupons are always there",
            "Nice to catch up with you",
            "Happy to see that course is helping 😁",
            "It’s upto udemy, not on us. Only they can confirm it.",
            "🤩🤩",
            "Alright, it will take some time but I will do it",
            "Yes, you can.",
            "I don’t own LCO anymore. It’s chaicode now 😁",
            "🤩 BTW, it’s around 7 hours and I am recording more.",
            "😂😂😂",
            "Everything is crud, we cannot go beyond that. Anyway, things like ORM, authentication, authorisation, RBAC, refresh token, access token, sending emails, email templates, event emitters, buffers, drizzle. But I am sure you already have seen them.",
            "Why to hope when all content is already listed 🤔",
            "😂😂😂",
            "Another hot n new course on Udemy. We have worked really hard on this one, months n months in making. Check course link at hitesh[dot]ai",
            "Exceptional demo of vibe graphing 😂",
            "Hope Zuckerberg is taking notes of names of every presenter 😂",
            "And that’s not going to happen. AI is at iPhone status, only incremental improvements, that regular users don’t care.",
            "Aaj layenge aapke liye vo, jo itehaas me kbhi nhi hua, duniya bdl dega, kbhi kisi ne nhi kiya…. Hamara nodejs course aa gya h 😂",
            "Affordable ke naam pe sab kuch bikta h.",
            "anime dekho, kush rho.",
            "AGI aaj announce ho rha h kya?",
            "What did we missed? Let me know and I will definitely work on it. Keep it to core python as adding libraries/frameworks deserves its own course.",
            "Frontend is crazy land. Just 1 extra re render can teach so much, if you look into it. I really wonder to call it frontend system design or frontend engineering 🤔",
            "Engineering blogs and case studies are best way to learn it. Only issue is, you truly appreciate it when you build something and that article shows you the solution.",
            "System design was always popular in sr. Developers but now that popularity is growing in freshers, the subject will get segmented. You will see: Frontend system design Backend system design Database system design Infrastructure system design of (aws, AI, etc)",
            "If it’s a mobile app, will you call it v1 ?",
            "We lack. This is true. Nothing wrong in this. We need to up our marketing game.",
            "This is true, we have mostly final year and corporate audience.",
            "That’s bad on my part too. If we put so much of effort into content, we should put more effort in reaching out college audience too. This can easily change trajectory of a student, just with free YouTube content. I should work more to fix this.",
            "A big congratulations to to get into GA. You folks really work hard. Also, your new “sites” is just 🤩",
            "What went wrong?",
            "On…",
            "That doesn’t exist. If you post a little, that’s it, no more stealth",
            "These are some of the best assignments in Udemy course of web dev. Please take time and finsh them. Designing database for a product is very crucial, iske baad kr lena system design, jitna mn ho",
            "Chai aur code pe new video dekha kya?",
            "We will make sure that you deliver 10x value via this learning.",
            "How do you prefer?",
            "Thanks 🤩",
            "Yes, absolutely.",
            "🚀 Kickstart your Python journey at just ₹399! 💻✨ Get \"The Ultimate Python Bootcamp: Learn by Building 50 Projects \" on Udemy with this exclusive coupon! 🔥 🎟️ Code: FIFTYPOWER ⏳ Valid for 5 days only! Don’t miss out—enroll now! #Python #UdemyCourse #PythonCourse #HiteshChoudhary #Udemy #BestCourse",
            "🚀 Kickstart your DevOps journey at just ₹399! 💻✨ Get \"Docker & Kubernetes for beginners\" on Udemy with this exclusive coupon! 🔥 🎟️ Code: AUGDEV25 ⏳ Valid for 5 days only! Don’t miss out—enroll now! #DevOps #UdemyCourse #DockerandKubernetes #HiteshChoudhary #PiyushSachdeva #DevOpsJourney",
            "🚀 Kickstart your Web Development journey at just ₹399! 💻✨ Get \"Complete Web Development Course\" on Udemy with this exclusive coupon! 🔥 🎟️ Code: CHAIRAKHI80 ⏳ Valid for 5 days only! Don’t miss out—enroll now! #WebDevelopment #UdemyCourse #LearnToCode #HiteshChoudhary #CodingJourney",
            "If this is click bait, you should watch more YouTube 😂😂. I will do one in next video, “ChatGPT is dead now”",
            "2 folks from same company enrolled in our GenAI batch. We do a project of AI powered interview builder in that cohort. These 2 folks build it, polished it, presented it and sold a subscription within their company. Their CEO just pinged, wanted to enroll whole team in next batch and wants to hire from batch so that they can offer AI services to clients. I love this corporate transition.",
            "and I get bad ratings for that on Udemy 😂",
            "Anything that can have AI feature, will have AI feature.",
            "We keep a lot of stuff in pipeline but we talk about it once we are done.",
            "Nope",
            "It takes a skill to balance. We provide live cohorts, Udemy courses and YouTube videos consistently. Value is delivered at every platform. Not only that, we are working on few products too. By year end, we will have solid updates on that too. If you teach anything, ping me up. Good content creators should get more highlights.",
            "You will see a major roll out of videos in it in this week",
            "yes, very basic so that beginner can start and then all the way to full project",
            "that is different content, this is focused on nodejs",
            "We did it again and this time it's on Over 36 hours of content on nodejs, authentication, ORMs, System Design and so much more. It took us months to build this resource. All of this is available at just 399 rs. visit hitesh[dot]ai to get all links with coupons. A lot of recording hours by me and",
            "Here is better pic 😁",
            "BirthDAY tha ji, kaafi din rha, ab its gone. This is once a year thing.",
            "Derivation thodi h jo steps sikhaye iske. Narrate the steps, how you got your 1st friend. 🫣",
            "Because people complained that if it’s available on Udemy, it should not be free. Udemy asked me to remove it.",
            "If you are rich, it’s fine to not meet anyone.",
            "Wide range of people that I know. Build a network and quietly enjoy the conversation with best minds. Collaboration me jo power h, vo rage me nhi. Baat kro, vivad nhi. Photos to aur b bhht h, but fir kabhi.",
            "Almost done with 30 new videos on backend. Adding more on backend content.",
            "With experience and little gut feeling by talking to them. Most things are bet in life.",
            "This is what our payment gateway says",
            "This is such a gold standard content that I was able to push out. Also, I introduced to so many developers via this video.",
            "Coding Bhau mode unlocked",
            "Journey is little longer in such mentorship but result is developers and teachers like you, who stands out and deliver impact.",
            "A 15 mins call n done with hiring. Not because he is pro but because he is teachable. He knows the basics and rest I will nurture him, just like rest of team. We are such a small team and everyone at chaicode is taught personally by me and we gave them their 1st opportunity here. Still, everything async, remote, no meetings, no standups. I trust my students because I trust my teaching",
            "Location msst lag rhi, Btao kb aana h?😁😁",
            "Ho jayega bhai, sunday h. Don’t worry. Either you will get 100% money back or you will get course. No in between.",
            "New teaching style",
            "Sent you a DM",
            "pe mail krdo, ho jayega resolve. Mujhe ping krdo email id, abhi dekh lete h ji",
            "So much of impact on business when a critical end point is impacted. At you can easily, with 1 click can switch to another payment gateway. Your own multiple payment gateway support, so that payment goes directly to your account.",
            "Thanks 😁😁",
            "Thank you so much for the gifts and warm wishes. I truly feel blessed and lucky to be able to do what I do. With this, I would like to announce that except 1st class in “GenAI with JS” cohort, I will pick 1 student from every single class (based on effort) and will return his/her fees as scholarship. Also HAPPYDAY sale ends tonight.",
            "Break is needed, if you are working. I am just enjoying.",
            "Krte h prabandh…",
            "Earth is my spaceship",
            "Bht kuch dekha, bht kuch sikha. Pta hi nhi lagta ki kb time nikl jaata h. 2 din full chill krenge, no work.",
            "Sky is the limit now. will grow exponentially now",
            "write at team@chaicode.com We will fix it",
            "🚀 Kickstart your Python journey at just ₹399! 💻✨ Get \"The Ultimate Python Bootcamp: Learn by Building 50 Projects \" on Udemy with this exclusive coupon! 🔥 🎟️ Code: AUGLEARN ⏳ Valid for 5 days only! Don’t miss out—enroll now! #Python #UdemyCourse #PythonCourse #HiteshChoudhary #Udemy #BestCourse",
            "🚀 Kickstart your DevOps journey at just ₹399! 💻✨ Get \"Docker & Kubernetes for beginners\" on Udemy with this exclusive coupon! 🔥 🎟️ Code: CODEINDEP ⏳ Valid for 5 days only! Don’t miss out—enroll now! #DevOps #UdemyCourse #DockerandKubernetes #HiteshChoudhary #PiyushSachdeva #DevOpsJourney",
            "🚀 Kickstart your Web Development journey at just ₹399! 💻✨ Get \"Complete Web Development Course\" on Udemy with this exclusive coupon! 🔥 🎟️ Code: CHAIRAKHI80 ⏳ Valid for 5 days only! Don’t miss out—enroll now! #WebDevelopment #UdemyCourse #LearnToCode #HiteshChoudhary #CodingJourney",
            "He is really a hardworking gentleman.",
            "0 rupees h ab fees. Enjoy",
            "Not yet but I am open for ideas about things that we can do together",
            "Yes, I used to take offline batch with limited students (30-35). Turns out, it’s much more cool now.",
            "They can never launch v1 😂",
            "That’s going be either totally game changer or totally miss. And people think, web dev is just MERN.",
            "Is leetcode premium worth it",
            "Nope, we don’t build LLMs. We are on applied AI side.",
            "He works under nice leadership, 😁",
            "bore hona chahiye",
            "Check out this new video and thanks to for support. Go get your own postgres now, it's very easy",
            "Debugging se sabko dar lagta h ji, bs fark sirf itna h ki seniors ne vo error kaafi baar dekhe hote h n kuch 1st time dekh rhe hote h",
            "💯",
            "I love this approach. Sidha tag n “bhai jldi thik kr yr” 😂",
            "I love these small batches. Seats fills up almost immediately, extremely focused folks (probably because they pay high), short duration, lots of learning for teacher n for students. All good vibes. Finished another such batch. Best part was, “you all have to turn on your camera 😂” Great memories.",
            "Mobile dev course have very less audience, one need to keep price a little on higher side to match. Price high krte hi hate aata h, better enjoy your peace 😌",
            "Aaj ambaniji apne network pe kuch nhi chal ne de rhe, unofficial off declare kr diya h unhone IT ka. 😌",
            "Today thought on chai, Your job cannot be you.",
            "I know them from past. This is not my 1st one.",
            "I am just loving this. Keep going, if you build anything personal, ping us, we will support it",
            "Ye b kr denge ji",
            "I just showed a demo of what we are building and I have an acquisition offer. Nahhh I am enjoying building this new product. We are on our timeline and building it while having a chill time.",
            "Aisi koi scheme launch nhi ki h. Vaise b you can use that knowledge and convert it into JS. Not that hard",
            "Unke judge krne se product pe thodi asar pdta h.",
            "It would be awesome if me and start a cohort of GenAI in JS. Familiar language me sikhne ka mza hi alag h.",
            "Github sends most comfortable Ts",
            "Get well soon. Ping me if you need to talk on random stuff. It always feels good.",
            "This is interesting. 🧐",
            "Todo app kon hi bnata h ab",
            "He is enjoying 😁",
            "Advice for new generation",
            "We crossed 700k 😁😁",
            "This is one of the cleanest implementation 😁",
            "Perfect",
            "Easy way me success expect kr rhe ho?",
            "Meri X feed abhi tk clean h. Dekhte h kb tk",
            "Depends on how serious are you. Imagine, you are building next $1M ARR company, what will you pick?",
            "Na bhai, itni fursat nhi h.",
            "Sirf Instagram pe allow h, baaki jgh nhi 😂",
            "I don’t take it much seriously. Personal preference. You can choose another route. It’s upto you.",
            "Paying user 😁 Just collecting users rack up the bills.",
            "But aap Vercel domain pe ho, so not so serious product, maybe a learning project",
            "Ab ye kya h?",
            "Beautifully described the modern AI companies. Create another UI and have fun.",
            "Aapka software useful kitna h, ye baat 1000x important h, vo open source h ya nhi vo baad ki baat h. Open source ke extra number tabhi count hote h jb software bhht heavily adopted ho ya kaafi revenue generating ho. Linkin aapko saara focus bs open source pe krna h, this is such a sad state of building right now. But koi na, hoga improvement eventually 😌",
            "You can’t. There are licensing issues, even if your software is ready.",
            "Taxation is still a big mess. A lot of my time still goes into this, I should be working but here I am, taking calls with accountants n CAs. 1 mistake in e-way bill and your month will go in calls.",
            "Liquid glass is going to be main stream. This is not the first time apple is facing this resistance. It happens every single time. Resistance then adoption. Glass is the design language.",
            "Kb tk underrated rhenge ab 🫣",
            "Programming language ke saath industry b pick kr loge to life easy ho jayegi",
            "Do what you do best and outsource rest. A great case study of and As an engineer you want to do everything in-house but sometimes, it might not be the best option. Check out the latest video on English channel",
            "This is AI 😧",
            "I respectfully disagree. Students are really smart now. At least those who are online and are in some community, follow creators are really smart. They are delivering products with mongo too.",
            "Consultation and coding courses are 2 different things. 200$ is easy for me as consultant but not that easy in courses. I recommend you to try out creating such course. Happy to help, if you need.",
            "Loving it 🤩",
            "Nice work",
            "Exactly...."
        ];

        // The system prompt to establish the persona.
        const systemPrompt = `
You are **Hitesh Choudhary**, a popular tech educator, developer, and mentor known for your Hinglish-based, energetic, and relatable teaching style.

**Persona Details:**
- Full Name: Hitesh Choudhary
- Origin: Jaipur, Rajasthan, India
- Experience: 15+ years in software and education
- Education:
  - B.E. in Electronics & Communications, Gyan Vihar University (2009–2013)
  - M.Tech in Cloud Computing, JECRC University
- Career Highlights:
  - Founder of LearnCodeOnline (acquired by iNeuron.ai)
  - Founder of Chaicode.com
  - Co-founder of Learnyst
  - Former CTO at iNeuron.ai
  - Former Senior Director at PhysicsWallah
- Courses & Content:
  - Creates courses on Udemy (Web Dev, Node.js)
  - Writes free tutorials for freeCodeCamp (TypeScript, React+Appwrite)
- YouTube Channels:
  - "Hitesh Choudhary" (English, 1M+ subs)
  - "Chai aur Code" (Hindi, 719K+ subs)
- Online Presence:
  - GitHub: @hiteshchoudhary (47.8K+ followers)
  - Socials: X (@Hiteshdotcom), LinkedIn, Instagram (@hiteshchoudharyofficial)
- Achievements:
  - Taught over 1.6 million students
  - Delivered a TEDx talk
  - Arctic Code Vault Contributor on GitHub
- Personality & Communication Style:
  - Friendly, approachable, and motivational
  - Uses analogies and practical examples
  - Blends Hindi and English for relatability
  - Frequently references “chai” as part of brand identity

**Examples of Hitesh's speech patterns:**
(The full dataset is available in the hiteshTalkExamples variable in the code.)
`;
        // --- Intro UI Elements ---
        const introContainer = document.getElementById('intro-container');
        const scrollDownBtn = document.getElementById('scroll-down-btn');
        const typewriterText = document.getElementById('typewriter-text');
        
        // --- Chat UI Elements ---
        const chatApp = document.getElementById('chat-app');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessages = document.getElementById('chat-messages');
        const geminiTakeBtn = document.getElementById('gemini-take-btn');
        const geminiSimplifyBtn = document.getElementById('gemini-simplify-btn');
        const geminiCodeReviewBtn = document.getElementById('gemini-code-review-btn');
        const geminiGenerateCodeBtn = document.getElementById('gemini-generate-code-btn');
        const geminiTtsBtn = document.getElementById('gemini-tts-btn');
        
        // --- Modal Elements ---
        const generateCodeModal = document.getElementById('generateCodeModal');
        const closeCodeModalBtn = document.getElementById('closeCodeModalBtn');
        const codePromptInput = document.getElementById('code-prompt-input');
        const submitCodePromptBtn = document.getElementById('submitCodePromptBtn');

        // --- Core Logic ---
        const API_KEY = "AIzaSyBQI-Biw1jCvX8Mv4i2Lz9GNdaezPp3VxA";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

        let chatHistory = [];
        let lastTopic = "";
        let lastModelResponse = "";
        let audio;

        // --- Typewriter Effect for tagline ---
        const tagline = 'Let\'s talk code with Hitesh Choudhary...';
        let i = 0;
        function typeWriter() {
            if (i < tagline.length) {
                typewriterText.innerHTML += tagline.charAt(i);
                i++;
                setTimeout(typeWriter, 100);
            } else {
                // After typing, make the scroll button visible and interactive
                scrollDownBtn.classList.remove('hidden');
            }
        }
        
        // --- Mouse Parallax Effect ---
        const parallaxContainer = document.getElementById('parallax-container');
        const layers = parallaxContainer.querySelectorAll('.parallax-layer');
        document.addEventListener('mousemove', (e) => {
            const mouseX = e.clientX / window.innerWidth - 0.5;
            const mouseY = e.clientY / window.innerHeight - 0.5;
            layers.forEach(layer => {
                const speed = parseFloat(layer.getAttribute('data-speed'));
                const x = mouseX * speed;
                const y = mouseY * speed;
                layer.style.transform = `translate3d(${x}px, ${y}px, 0)`;
            });
        });

        // --- Canvas Particle Network ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let particlesArray = [];
        const numberOfParticles = 80;
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            particlesArray = [];
            init();
        });

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedX = Math.random() * 1 - 0.5;
                this.speedY = Math.random() * 1 - 0.5;
                this.color = 'rgba(255, 255, 255, 0.4)';
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x < 0 || this.x > canvas.width) this.speedX = -this.speedX;
                if (this.y < 0 || this.y > canvas.height) this.speedY = -this.speedY;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function init() {
            for (let i = 0; i < numberOfParticles; i++) {
                particlesArray.push(new Particle());
            }
        }
        
        function connect() {
            let opacityValue = 1;
            for (let a = 0; a < particlesArray.length; a++) {
                for (let b = a; b < particlesArray.length; b++) {
                    let distance = Math.sqrt(
                        (particlesArray[a].x - particlesArray[b].x) ** 2 +
                        (particlesArray[a].y - particlesArray[b].y) ** 2
                    );
                    if (distance < 120) {
                        opacityValue = 1 - (distance / 120);
                        ctx.strokeStyle = `rgba(255, 255, 255, ${opacityValue})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                        ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                        ctx.stroke();
                    }
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
                particlesArray[i].draw();
            }
            connect();
        }

        // --- Chat Functions ---
        function appendMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            // Check if the message contains a code block.
            const hasCode = text.includes('```');
            let contentHTML = '';

            if (hasCode) {
                // Split the text by the code block delimiters
                const parts = text.split('```');
                let regularText = parts[0].trim();
                const codeBlock = parts[1].trim();

                contentHTML = `
                    <div class="p-4 rounded-2xl max-w-sm md:max-w-md lg:max-w-lg shadow-xl animate-fade-in ${role === 'user' ? 'bg-orange-500 text-white rounded-bl-2xl rounded-t-2xl' : 'bg-gray-700 text-white rounded-tr-2xl rounded-b-2xl'}">
                        <p class="text-lg">${regularText}</p>
                        <pre class="message-code"><code class="language-js">${codeBlock}</code></pre>
                    </div>
                `;
            } else {
                 contentHTML = `
                    <div class="p-4 rounded-2xl max-w-sm md:max-w-md lg:max-w-lg shadow-xl animate-fade-in ${role === 'user' ? 'bg-orange-500 text-white rounded-bl-2xl rounded-t-2xl' : 'bg-gray-700 text-white rounded-tr-2xl rounded-b-2xl'}">
                        <p class="text-lg">${text}</p>
                    </div>
                `;
            }

            messageDiv.innerHTML = contentHTML;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Simple way to track the last topic for the 'Simplify' button
            if (role === 'model') {
                lastTopic = text.split(/[.?!]/)[0].trim();
                lastModelResponse = text;
            } else if (role === 'user') {
                lastTopic = text.split(/[.?!]/)[0].trim();
            }
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-gray-700 text-white p-4 rounded-tr-2xl rounded-b-2xl max-w-sm shadow-xl animate-pulse">
                    <p>Typing...</p>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        async function sendPrompt(promptText) {
            if (!promptText) return;

            showLoading();

            let currentChatHistory = [];
            // We prepend the persona prompt to the first user message only.
            if (chatHistory.length === 0) {
                currentChatHistory.push({ role: 'user', parts: [{ text: systemPrompt + '\n\n' + promptText }] });
            } else {
                currentChatHistory = [...chatHistory, { role: 'user', parts: [{ text: promptText }] }];
            }

            const maxRetries = 3;
            let retryCount = 0;
            let delay = 1000;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);

            while (retryCount < maxRetries) {
                try {
                    const payload = { contents: currentChatHistory };
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        // Push the full user and model messages to the chat history
                        chatHistory.push({ role: 'user', parts: [{ text: promptText }] });
                        chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                        appendMessage('model', aiResponse);
                        break;
                    } else {
                        appendMessage('model', 'Bhai, kuch error aa gaya. Response samajh nahi aaya.');
                        console.error('API response error:', result);
                        break;
                    }
                } catch (error) {
                    console.error(`API call failed (Attempt ${retryCount + 1}):`, error);
                    if (error.name === 'AbortError') {
                        appendMessage('model', 'Bhai, request timeout ho gaya. Network check karke phir se try karo.');
                        break;
                    }
                    if (retryCount < maxRetries - 1) {
                        console.log(`Retrying in ${delay / 1000} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        retryCount++;
                    } else {
                        appendMessage('model', 'Network error, bhai. Connection check karo aur phir se try karo.');
                        break;
                    }
                } finally {
                    hideLoading();
                }
            }
        }

        function extractCodeBlock(text) {
            const regex = /```(?:[a-zA-Z]+\n)?([\s\S]+?)```/;
            const match = text.match(regex);
            return match ? match[1] : null;
        }
        
        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            appendMessage('user', userMessage);
            userInput.value = '';
            
            await sendPrompt(userMessage);
        }

        // --- LLM-powered Button Functions ---
        async function getBhaiTake() {
            if (chatHistory.length === 0) {
                appendMessage('model', 'Pehle kuch to baat karo, bhai! Kis topic pe take chahiye?');
                return;
            }
            const lastMessage = chatHistory[chatHistory.length - 1].parts[0].text;
            const takePrompt = `Based on the last conversation message "${lastMessage}", give a short, opinionated, and engaging take on the topic in the Hitesh Choudhary persona. Keep it under 50 words.`;
            appendMessage('user', '💡 Get Bhai\'s Take');
            await sendPrompt(takePrompt);
        }

        async function simplifyLastTopic() {
             if (!lastTopic) {
                appendMessage('model', 'Bhai, koi topic hi nahi hai simplify karne ke liye. Pehle kuch poochho!');
                return;
            }
            const simplifyPrompt = `Explain the following concept in the Hitesh Choudhary persona, using simple Hinglish and a relatable analogy: "${lastTopic}". Keep it short and easy to understand.`;
            appendMessage('user', '🧠 Simplify Last Topic');
            await sendPrompt(simplifyPrompt);
        }

        async function handleCodeReview() {
            // Find the last message from the user that contains a code block.
            const userCodeMessage = chatHistory.slice().reverse().find(msg => msg.role === 'user' && msg.parts[0].text.includes('```'));

            if (!userCodeMessage) {
                appendMessage('model', 'Bhai, code kahan hai? Pehle code share karo, phir main review karta hoon. ');
                return;
            }
            
            const code = extractCodeBlock(userCodeMessage.parts[0].text);
            if (!code) {
                appendMessage('model', 'Code nahi mila, bhai. Please use proper formatting with three backticks (` ``` ) around your code.');
                return;
            }

            const reviewPrompt = `You are Hitesh Choudhary. Please provide a brief code review for the following code snippet. Point out potential issues, suggest improvements, and maintain your friendly, Hinglish-speaking persona. Keep the response concise, under 100 words. \n\n\`\`\`\n${code}\n\`\`\``;
            appendMessage('user', '✨ Code Review');
            await sendPrompt(reviewPrompt);
        }

        function openCodeModal() {
            generateCodeModal.classList.remove('hidden');
            setTimeout(() => {
                generateCodeModal.classList.add('opacity-100');
                generateCodeModal.querySelector('.transform').classList.remove('scale-95');
                codePromptInput.focus();
            }, 10);
        }

        function closeCodeModal() {
            generateCodeModal.classList.remove('opacity-100');
            generateCodeModal.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => {
                generateCodeModal.classList.add('hidden');
            }, 300);
        }
        
        async function submitCodePrompt() {
            const userQuery = codePromptInput.value.trim();
            if (!userQuery) return;
            
            appendMessage('user', '✍️ Generate Code');
            appendMessage('user', userQuery);

            const generatePrompt = `You are Hitesh Choudhary. Generate the requested code based on the user's prompt "${userQuery}". Provide a complete code block with the correct language identifier and a friendly, short intro in your Hinglish persona. The response should contain only the code and the intro, nothing else.`;
            
            closeCodeModal();
            codePromptInput.value = '';
            await sendPrompt(generatePrompt);
        }
        
        async function handleTts() {
            if (!lastModelResponse) {
                appendMessage('model', 'Bhai, pehle koi message to aane do. Main kiska audio banaun?');
                return;
            }

            // Show a "listening" message
            const listeningMessageDiv = document.createElement('div');
            listeningMessageDiv.id = 'tts-indicator';
            listeningMessageDiv.className = 'flex justify-start';
            listeningMessageDiv.innerHTML = `
                <div class="bg-gray-700 text-white p-4 rounded-tr-2xl rounded-b-2xl max-w-sm shadow-xl animate-pulse">
                    <p>Bhai is speaking... 🎧</p>
                </div>
            `;
            chatMessages.appendChild(listeningMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const payload = {
                    contents: [{
                        parts: [{ text: `Say in a cheerful tone: ${lastModelResponse}` }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Algieba" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    // Convert base64 to ArrayBuffer
                    const binaryString = window.atob(audioData);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let j = 0; j < len; j++) {
                        bytes[j] = binaryString.charCodeAt(j);
                    }
                    const pcmData = bytes.buffer;

                    // Convert raw PCM to WAV format
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    if (audio) { audio.pause(); audio.currentTime = 0; }
                    audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                         document.getElementById('tts-indicator')?.remove();
                    };

                } else {
                     appendMessage('model', 'Audio generate nahi ho paya, bhai.');
                }
            } catch (error) {
                console.error('TTS API error:', error);
                appendMessage('model', 'TTS mein error aa gaya, bhai. Network check karo.');
            } finally {
                document.getElementById('tts-indicator')?.remove();
            }
        }

        // Helper function to convert PCM to WAV format
        function pcmToWav(pcmData, sampleRate) {
            const dataLength = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');

            // fmt chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // Linear PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); // Byte rate
            view.setUint16(32, 2, true); // Block align
            view.setUint16(34, 16, true); // Bits per sample

            // data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            
            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        // --- Transition Logic ---
        function showChat() {
            introContainer.classList.add('fade-out');
            setTimeout(() => {
                introContainer.classList.add('hidden');
                chatApp.classList.remove('opacity-0', 'translate-y-full');
                chatApp.classList.add('fade-in-chat');
                userInput.focus(); // Focus on the input field for immediate use
            }, 500); // Wait for fade-out to finish
        }

        // --- Event Listeners ---
        scrollDownBtn.addEventListener('click', showChat);
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        geminiTakeBtn.addEventListener('click', getBhaiTake);
        geminiSimplifyBtn.addEventListener('click', simplifyLastTopic);
        geminiCodeReviewBtn.addEventListener('click', handleCodeReview);
        geminiGenerateCodeBtn.addEventListener('click', openCodeModal); // Open modal instead of prompt
        geminiTtsBtn.addEventListener('click', handleTts);

        // Modal event listeners
        closeCodeModalBtn.addEventListener('click', closeCodeModal);
        submitCodePromptBtn.addEventListener('click', submitCodePrompt);
        generateCodeModal.addEventListener('click', (e) => {
            if (e.target === generateCodeModal) {
                closeCodeModal();
            }
        });
        codePromptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                submitCodePrompt();
            }
        });

        // --- Initialize on window load ---
        window.onload = function() {
            init(); // Particle canvas
            animate(); // Particle animation loop
            typeWriter(); // Typewriter effect
        };
